<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }

    h2 {
      margin-bottom: 10px;
    }

    h3 {
      margin-top: 30px;
      margin-bottom: 10px;
      color: #4CAF50;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 30px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .back-link {
      margin-bottom: 15px;
      display: inline-block;
      text-decoration: none;
      color: #4CAF50;
      font-weight: bold;
    }

    #searchBox {
      margin: 15px 0 25px;
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 4px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-link">‚Üê Back to Scanner</a>
  <h2>Inventory Viewer</h2>

  <input type="text" id="searchBox" placeholder="Search items, units, or notes..." />

  <div id="groupedTables"></div>

  <script>
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yy = String(date.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    let allSections = [];

    fetch('https://script.google.com/macros/s/AKfycbzU-hHQz3SiqivqTlSwsDX1NaDaKHSpzujWbxGMj6q9C1WP9AkJtTTtNZaklw1nTmTVBA/exec')
      .then(response => response.json())
      .then(data => {
        const grouped = {};
        data.slice(1).forEach(row => {
          const location = row[7] || "Unspecified";
          if (!grouped[location]) grouped[location] = [];
          grouped[location].push(row);
        });

        const container = document.getElementById("groupedTables");
        container.innerHTML = "";

        Object.keys(grouped).sort().forEach(location => {
          const section = document.createElement("div");
          allSections.push(section);

          const heading = document.createElement("h3");
          heading.textContent = location;
          section.appendChild(heading);

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          ["#", "Item", "Qty", "Unit", "Purchase Date", "Expiry Date", "Notes"].forEach(text => {
            const th = document.createElement("th");
            th.textContent = text;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          grouped[location].forEach((row, index) => {
            const tr = document.createElement("tr");

            const indices = [1, 3, 4, 5, 6, 8]; // omit ID, barcode, location
            const valuesToSearch = []; // for filtering

            const serialTd = document.createElement("td");
            serialTd.textContent = index + 1;
            tr.appendChild(serialTd);

            indices.forEach(i => {
              const td = document.createElement("td");
              let value = (i === 5 || i === 6) ? formatDate(row[i]) : row[i];
              td.textContent = value;
              tr.appendChild(td);
              valuesToSearch.push((value || "").toString().toLowerCase());
            });

            tr.setAttribute("data-search", valuesToSearch.join(" "));
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          section.appendChild(table);
          container.appendChild(section);
        });
      })
      .catch(error => {
        alert("Failed to load inventory data.");
        console.error("Fetch error:", error);
      });

    document.getElementById("searchBox").addEventListener("input", function () {
      const query = this.value.trim().toLowerCase();

      allSections.forEach(section => {
        const rows = section.querySelectorAll("tbody tr");
        let anyVisible = false;

        rows.forEach(row => {
          const text = row.getAttribute("data-search");
          const match = text.includes(query);
          row.classList.toggle("hidden", !match);
          if (match) anyVisible = true;
        });

        section.style.display = anyVisible ? "" : "none";
      });
    });
  </script>
</body>
</html>
