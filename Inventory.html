<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Viewer</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    td[contenteditable="true"] { background: #ffffcc; }
    .save-button { background: #4CAF50; color: white; padding: 4px 10px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Inventory Viewer</h2>
  <div id="inventoryTable">Loading...</div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzU-hHQz3SiqivqTlSwsDX1NaDaKHSpzujWbxGMj6q9C1WP9AkJtTTtNZaklw1nTmTVBA/exec"; // Paste your deployed Apps Script URL here

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      return isNaN(date) ? "" : date.toLocaleDateString("en-GB");
    }

    async function loadInventory() {
      const res = await fetch(scriptURL);
      const data = await res.json();
      const header = data[0];
      const rows = data.slice(1);

      let html = `<table><thead><tr>
        <th>#</th><th>Item</th><th>Qty</th><th>Unit</th><th>Purchase</th><th>Expiry</th><th>Notes</th><th>Action</th>
      </tr></thead><tbody>`;

      rows.forEach((row, i) => {
        html += `<tr data-id="${i + 2}">
          <td>${i + 1}</td>
          <td>${row[1]}</td>
          <td contenteditable="true" data-col="4">${row[3]}</td>
          <td contenteditable="true" data-col="5">${row[4]}</td>
          <td contenteditable="true" data-col="6">${formatDate(row[5])}</td>
          <td contenteditable="true" data-col="7">${formatDate(row[6])}</td>
          <td contenteditable="true" data-col="9">${row[8] || ""}</td>
          <td><button class="save-button">Save</button></td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("inventoryTable").innerHTML = html;

      document.querySelectorAll(".save-button").forEach(button => {
        button.addEventListener("click", async () => {
          const row = button.closest("tr");
          const rowId = row.dataset.id;
          const cells = row.querySelectorAll("td[contenteditable='true']");

          for (const cell of cells) {
            const col = cell.dataset.col;
            const value = cell.innerText.trim();
            const payload = {
              action: "update",
              row: parseInt(rowId),
              col: parseInt(col),
              value: value
            };

            try {
              const res = await fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              const result = await res.json();
              cell.style.backgroundColor = result.success ? "#d4edda" : "#f8d7da";
              setTimeout(() => cell.style.backgroundColor = "", 800);
            } catch (err) {
              cell.style.backgroundColor = "#f8d7da";
              setTimeout(() => cell.style.backgroundColor = "", 800);
            }
          }
        });
      });
    }

    loadInventory();
  </script>
</body>
</html>
