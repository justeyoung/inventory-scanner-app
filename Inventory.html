<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }

    h2 {
      margin-bottom: 10px;
    }

    h3 {
      margin-top: 30px;
      margin-bottom: 10px;
      color: #4CAF50;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .back-link {
      margin-bottom: 15px;
      display: inline-block;
      text-decoration: none;
      color: #4CAF50;
      font-weight: bold;
    }

    #searchBox, #expiryFilter {
      margin: 10px 0 20px;
      padding: 8px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }

    .download-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      margin-bottom: 30px;
      cursor: pointer;
      border-radius: 4px;
    }

    .hidden {
      display: none;
    }

    .expired {
      color: red;
      font-weight: bold;
    }

    .expiring-soon {
      color: darkorange;
    }
  </style>
</head>
<body>

  <a href="index.html" class="back-link">‚Üê Back to Scanner</a>
  <h2>Inventory Viewer</h2>

  <input type="text" id="searchBox" placeholder="Search items, units, or notes..." />
  <select id="expiryFilter">
    <option value="all">Show all</option>
    <option value="expired">Expired only</option>
    <option value="soon">Expiring within 3 days</option>
  </select>

  <div id="groupedTables"></div>

  <script>
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yy = String(date.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function classifyExpiry(dateStr) {
      if (!dateStr) return "";
      const today = new Date();
      const expiry = new Date(dateStr);
      if (isNaN(expiry)) return "";
      const diff = (expiry - today) / (1000 * 60 * 60 * 24);
      if (diff < 0) return "expired";
      if (diff <= 3) return "soon";
      return "";
    }

    let allSections = [];

    fetch('https://script.google.com/macros/s/AKfycbzU-hHQz3SiqivqTlSwsDX1NaDaKHSpzujWbxGMj6q9C1WP9AkJtTTtNZaklw1nTmTVBA/exec')
      .then(response => response.json())
      .then(data => {
        const grouped = {};
        data.slice(1).forEach(row => {
          const location = row[7] || "Unspecified";
          if (!grouped[location]) grouped[location] = [];
          grouped[location].push(row);
        });

        const container = document.getElementById("groupedTables");
        container.innerHTML = "";

        Object.keys(grouped).sort().forEach(location => {
          const section = document.createElement("div");
          allSections.push(section);

          const heading = document.createElement("h3");
          heading.textContent = location;
          section.appendChild(heading);

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          ["#", "Item", "Qty", "Unit", "Purchase Date", "Expiry Date", "Notes"].forEach(text => {
            const th = document.createElement("th");
            th.textContent = text;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          grouped[location].forEach((row, index) => {
            const tr = document.createElement("tr");

            const indices = [1, 3, 4, 5, 6, 8];
            const searchValues = [];

            const serialTd = document.createElement("td");
            serialTd.textContent = index + 1;
            tr.appendChild(serialTd);

            indices.forEach(i => {
              const td = document.createElement("td");
              let value = (i === 5 || i === 6) ? formatDate(row[i]) : row[i];
              if (i === 6) {
                const status = classifyExpiry(row[i]);
                if (status === "expired") td.classList.add("expired");
                else if (status === "soon") td.classList.add("expiring-soon");
                tr.setAttribute("data-expiry", status);
              }
              td.textContent = value;
              tr.appendChild(td);
              searchValues.push((value || "").toString().toLowerCase());
            });

            tr.setAttribute("data-search", searchValues.join(" "));
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          section.appendChild(table);

          const downloadBtn = document.createElement("button");
          downloadBtn.className = "download-btn";
          downloadBtn.textContent = `Download PDF: ${location}`;
          downloadBtn.addEventListener("click", () => {
            const visibleRows = table.querySelectorAll("tbody tr:not(.hidden)");

            if (visibleRows.length === 0) {
              alert("No visible rows to export.");
              return;
            }

            const pdfWrapper = document.createElement("div");

            const pdfTitle = document.createElement("h3");
            pdfTitle.textContent = location;
            pdfWrapper.appendChild(pdfTitle);

            const exportTable = document.createElement("table");
            exportTable.innerHTML = table.querySelector("thead").outerHTML;
            const exportTbody = document.createElement("tbody");

            visibleRows.forEach(row => {
              exportTbody.appendChild(row.cloneNode(true));
            });

            exportTable.appendChild(exportTbody);
            pdfWrapper.appendChild(exportTable);

            html2pdf().set({
              margin: 0.5,
              filename: `${location.replace(/\s+/g, "_")}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            }).from(pdfWrapper).save();
          });

          section.appendChild(downloadBtn);
          container.appendChild(section);
        });
      })
      .catch(error => {
        alert("Failed to load inventory data.");
        console.error("Fetch error:", error);
      });

    function applyFilters() {
      const query = document.getElementById("searchBox").value.trim().toLowerCase();
      const expiryFilter = document.getElementById("expiryFilter").value;

      allSections.forEach(section => {
        const rows = section.querySelectorAll("tbody tr");
        let anyVisible = false;

        rows.forEach(row => {
          const text = row.getAttribute("data-search");
          const expiry = row.getAttribute("data-expiry") || "";
          const matchText = text.includes(query);
          const matchExpiry =
            expiryFilter === "all" ||
            (expiryFilter === "expired" && expiry === "expired") ||
            (expiryFilter === "soon" && expiry === "soon");

          const visible = matchText && matchExpiry;
          row.classList.toggle("hidden", !visible);
          if (visible) anyVisible = true;
        });

        section.style.display = anyVisible ? "" : "none";
      });
    }

    document.getElementById("searchBox").addEventListener("input", applyFilters);
    document.getElementById("expiryFilter").addEventListener("change", applyFilters);
  </script>
</body>
</html>
