<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    .location-group {
      margin-bottom: 40px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    td[contenteditable="true"] {
      background-color: #fff7cc;
      cursor: text;
    }
    .updated {
      background-color: #d4edda !important;
    }
  </style>
</head>
<body>
  <a href="index.html" style="color: green;">&larr; Back to Scanner</a>
  <h2>Inventory Viewer</h2>
  <div id="inventoryContainer"></div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzU-hHQz3SiqivqTlSwsDX1NaDaKHSpzujWbxGMj6q9C1WP9AkJtTTtNZaklw1nTmTVBA/exec";

    async function loadInventory() {
      const response = await fetch(SHEET_URL);
      const data = await response.json();

      const headers = data[0];
      const rows = data.slice(1);

      // Group by location
      const locationGroups = {};
      rows.forEach((row, index) => {
        const location = row[7] || 'Unspecified';
        if (!locationGroups[location]) locationGroups[location] = [];
        locationGroups[location].push({ rowIndex: index + 2, row }); // +2 for headers
      });

      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '';

      Object.keys(locationGroups).forEach(location => {
        const section = document.createElement('div');
        section.className = 'location-group';
        section.innerHTML = `<h3 style="color: green;">${location}</h3>`;

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        ['#', 'Item', 'Qty', 'Unit', 'Purchase Date', 'Expiry Date', 'Notes'].forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        locationGroups[location].forEach((entry, idx) => {
          const tr = document.createElement('tr');
          const row = entry.row;

          // Serial #
          tr.appendChild(createCell(idx + 1, false));

          // Editable fields
          const editableFields = [
            { index: 1, name: 'Item' },
            { index: 3, name: 'Quantity' },
            { index: 4, name: 'Unit' },
            { index: 5, name: 'Purchase Date' },
            { index: 6, name: 'Expiry Date' },
            { index: 8, name: 'Notes' }
          ];

          editableFields.forEach(field => {
            const td = createCell(row[field.index], true);
            td.dataset.rowIndex = entry.rowIndex;
            td.dataset.columnName = field.name;
            td.addEventListener('blur', () => updateCell(td));
            td.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                td.blur();
              }
            });
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        section.appendChild(table);
        container.appendChild(section);
      });
    }

    function createCell(value, editable) {
      const td = document.createElement('td');
      td.textContent = value ?? '';
      if (editable) td.setAttribute('contenteditable', 'true');
      return td;
    }

    async function updateCell(td) {
      const newValue = td.textContent.trim();
      const rowIndex = td.dataset.rowIndex;
      const columnName = td.dataset.columnName;

      const res = await fetch(SHEET_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'update',
          rowIndex: parseInt(rowIndex),
          columnName,
          newValue
        }),
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await res.json();
      if (result.success) {
        td.classList.add('updated');
        setTimeout(() => td.classList.remove('updated'), 1000);
      } else {
        alert("Update failed: " + result.error);
      }
    }

    loadInventory();
  </script>
</body>
</html>
