<!-- All previous <head> section remains the same, including styling and html2pdf script -->

<body>
  <a href="index.html" class="back-link">‚Üê Back to Scanner</a>
  <h2>Inventory Viewer</h2>

  <input type="text" id="searchBox" placeholder="Search items, units, or notes..." />
  <select id="expiryFilter">
    <option value="all">Show all</option>
    <option value="expired">Expired only</option>
    <option value="soon">Expiring within 3 days</option>
  </select>

  <select id="locationSelect">
    <option value="all">All locations</option>
  </select>

  <button class="download-selected-btn" id="downloadSelectedBtn">Download PDF for Selected Location</button>

  <div id="groupedTables"></div>

  <script>
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yy = String(date.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function classifyExpiry(dateStr) {
      if (!dateStr) return "";
      const today = new Date();
      const expiry = new Date(dateStr);
      if (isNaN(expiry)) return "";
      const diff = (expiry - today) / (1000 * 60 * 60 * 24);
      if (diff < 0) return "expired";
      if (diff <= 3) return "soon";
      return "";
    }

    let allSections = [];
    let sectionMap = {};

    fetch('https://script.google.com/macros/s/AKfycbzU-hHQz3SiqivqTlSwsDX1NaDaKHSpzujWbxGMj6q9C1WP9AkJtTTtNZaklw1nTmTVBA/exec')
      .then(response => response.json())
      .then(data => {
        const grouped = {};
        data.slice(1).forEach(row => {
          const location = row[7] || "Unspecified";
          if (!grouped[location]) grouped[location] = [];
          grouped[location].push(row);
        });

        const locationSelect = document.getElementById("locationSelect");
        const container = document.getElementById("groupedTables");
        container.innerHTML = "";

        Object.keys(grouped).sort().forEach(location => {
          const section = document.createElement("div");
          section.dataset.location = location;
          sectionMap[location] = section;
          allSections.push(section);

          const option = document.createElement("option");
          option.value = location;
          option.textContent = location;
          locationSelect.appendChild(option);

          const heading = document.createElement("h3");
          heading.textContent = location;
          section.appendChild(heading);

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          ["#", "Item", "Qty", "Unit", "Purchase Date", "Expiry Date", "Notes"].forEach(text => {
            const th = document.createElement("th");
            th.textContent = text;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          grouped[location].forEach((row, index) => {
            const tr = document.createElement("tr");

            const indices = [1, 3, 4, 5, 6, 8];
            const searchValues = [];

            const serialTd = document.createElement("td");
            serialTd.textContent = index + 1;
            tr.appendChild(serialTd);

            indices.forEach(i => {
              const td = document.createElement("td");
              let value = (i === 5 || i === 6) ? formatDate(row[i]) : row[i];
              if (i === 6) {
                const status = classifyExpiry(row[i]);
                if (status === "expired") td.classList.add("expired");
                else if (status === "soon") td.classList.add("expiring-soon");
                tr.setAttribute("data-expiry", status);
              }
              td.textContent = value;
              tr.appendChild(td);
              searchValues.push((value || "").toString().toLowerCase());
            });

            tr.setAttribute("data-search", searchValues.join(" "));
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          section.appendChild(table);
          container.appendChild(section);
        });

        applyFilters();
      })
      .catch(error => {
        alert("Failed to load inventory data.");
        console.error("Fetch error:", error);
      });

    function applyFilters() {
      const query = document.getElementById("searchBox").value.trim().toLowerCase();
      const expiryFilter = document.getElementById("expiryFilter").value;
      const locationFilter = document.getElementById("locationSelect").value;

      allSections.forEach(section => {
        const rows = section.querySelectorAll("tbody tr");
        const thisLocation = section.dataset.location;
        const showSection = locationFilter === "all" || locationFilter === thisLocation;

        let anyVisible = false;
        rows.forEach(row => {
          const text = row.getAttribute("data-search");
          const expiry = row.getAttribute("data-expiry") || "";
          const matchText = text.includes(query);
          const matchExpiry =
            expiryFilter === "all" ||
            (expiryFilter === "expired" && expiry === "expired") ||
            (expiryFilter === "soon" && expiry === "soon");

          const visible = matchText && matchExpiry;
          row.classList.toggle("hidden", !visible);
          if (visible) anyVisible = true;
        });

        section.style.display = showSection && anyVisible ? "" : "none";
      });
    }

    document.getElementById("searchBox").addEventListener("input", applyFilters);
    document.getElementById("expiryFilter").addEventListener("change", applyFilters);
    document.getElementById("locationSelect").addEventListener("change", applyFilters);

    document.getElementById("downloadSelectedBtn").addEventListener("click", () => {
      const selectedLocation = document.getElementById("locationSelect").value;
      if (!selectedLocation || selectedLocation === "all") {
        alert("Please select a location first.");
        return;
      }

      const section = sectionMap[selectedLocation];
      const table = section.querySelector("table");
      const heading = section.querySelector("h3");

      const visibleRows = table.querySelectorAll("tbody tr:not(.hidden)");
      if (visibleRows.length === 0) {
        alert("No visible rows to export for this location.");
        return;
      }

      const pdfWrapper = document.createElement("div");
      const pdfTitle = document.createElement("h3");
      pdfTitle.textContent = selectedLocation;
      pdfWrapper.appendChild(pdfTitle);

      const exportTable = document.createElement("table");
      exportTable.innerHTML = table.querySelector("thead").outerHTML;
      const exportTbody = document.createElement("tbody");

      visibleRows.forEach(row => {
        exportTbody.appendChild(row.cloneNode(true));
      });

      exportTable.appendChild(exportTbody);
      pdfWrapper.appendChild(exportTable);

      html2pdf().set({
        margin: 0.5,
        filename: `${selectedLocation.replace(/\s+/g, "_")}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      }).from(pdfWrapper).save();
    });
  </script>
</body>
</html>
